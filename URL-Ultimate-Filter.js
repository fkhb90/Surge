/**
 * @file        URL-Ultimate-Filter-Surge-V40.83.js
 * @version     40.83 (ÂÆåÂÖ®ÈáçÊßã‰øÆÊ≠£Áâà)
 * @description ÂæπÂ∫ïËß£Ê±∫ÈªëÁôΩÂêçÂñÆÂ§±ÊïàÂïèÈ°åÔºåÈáçÊñ∞Ë®≠Ë®àÈÅéÊøæÈÇèËºØ
 * @author      Claude & Community Optimization
 * @lastUpdated 2025-09-24
 */

// ================================================================================================
//                           üîß STEP 1: CONFIGURATION VALIDATION
// ================================================================================================

// Á¢∫‰øùÊâÄÊúâÈÖçÁΩÆÈ†ÖÈÉΩËÉΩÊ≠£Á¢∫ÂàùÂßãÂåñ
function createValidatedSet(items) {
  try {
    return new Set(Array.isArray(items) ? items : []);
  } catch (error) {
    console.error('[CONFIG] Set creation failed:', error);
    return new Set();
  }
}

function createValidatedRegexArray(patterns) {
  const validPatterns = [];
  if (!Array.isArray(patterns)) return validPatterns;

  for (const pattern of patterns) {
    try {
      if (pattern instanceof RegExp) {
        validPatterns.push(pattern);
      } else if (typeof pattern === 'string') {
        validPatterns.push(new RegExp(pattern, 'i'));
      }
    } catch (error) {
      console.error('[CONFIG] Regex creation failed:', error);
    }
  }
  return validPatterns;
}

// ================================================================================================
//                           ‚öôÔ∏è STEP 2: CONFIGURATION SETUP
// ================================================================================================

const CONFIG = {
  // ÊïàËÉΩË®≠ÂÆö
  PERFORMANCE: {
    DEBUG_MODE: false,
    CACHE_SIZE: 2048,
    REGEX_TIMEOUT: 100,
    MAX_URL_LENGTH: 4096
  },

  // üîÑ ÂïüÁôºÂºèÁõ¥Ë∑≥ÂüüÂêç (ÂÆåÂÖ®‰∏çÊîîÊà™)
  REDIRECTOR_HOSTS: createValidatedSet([
    '1ink.cc', '1link.club', 'adfoc.us', 'adsafelink.com', 'adshnk.com',
    'adz7short.space', 'aylink.co', 'bc.vc', 'bcvc.ink', 'birdurls.com',
    'bitcosite.com', 'blogbux.net', 'boost.ink', 'ceesty.com', 'clik.pw',
    'clk.sh', 'clkmein.com', 'cllkme.com', 'corneey.com', 'cpmlink.net',
    'cutpaid.com', 'destyy.com', 'dlink3.com', 'earnlink.io', 'exe-links.com',
    'exeo.app', 'fc-lc.com', 'festyy.com', 'fir3.net', 'gestyy.com',
    'gplinks.co', 'hotshorturl.com', 'icutlink.com', 'linegee.net', 'link1s.com',
    'linkmoni.com', 'linkpoi.me', 'linkshrink.net', 'linksly.co', 'lnk2.cc',
    'megalink.pro', 'met.bz', 'miniurl.pw', 'mitly.us', 'noweconomy.live',
    'oke.io', 'oko.sh', 'oni.vn', 'ouo.io', 'ouo.press', 'pahe.plus',
    'payskip.org', 'pingit.im', 'realsht.mobi', 'rlu.ru', 'sh.st',
    'short.am', 'shortlinkto.biz', 'shortmoz.link', 'shrinkcash.com',
    'shrt10.com', 'smilinglinks.com', 'spacetica.com', 'spaste.com',
    'srt.am', 'stfly.me', 'stfly.xyz', 'thinfi.com', 'tmearn.net',
    'tnshort.net', 'turkdown.com', 'tutwuri.id', 'uplinkto.hair',
    'urlcash.com', 'urlcash.org', 'vinaurl.net', 'vzturl.com',
    'xpshort.com', 'zegtrends.com'
  ]),

  // ‚úÖ Á°¨ÁôΩÂêçÂñÆ - Á≤æÁ¢∫ÂüüÂêç (ÁµïÂ∞ç‰∏çÊîîÊà™)
  HARD_WHITELIST_EXACT: createValidatedSet([
    // AI ÊúçÂãô
    'chatgpt.com', 'claude.ai', 'gemini.google.com', 'perplexity.ai',
    'bard.google.com', 'chat.openai.com', 'api.openai.com',

    // ÈñãÁôºÂ∑•ÂÖ∑
    'raw.githubusercontent.com', 'api.github.com', 'userscripts.adtidy.org',
    'github.com', 'stackoverflow.com', 'developer.mozilla.org',

    // Ê†∏ÂøÉÈ©óË≠âÊúçÂãô
    'accounts.google.com', 'appleid.apple.com', 'login.microsoftonline.com',
    'secure.gravatar.com', 'auth0.com', 'oauth.com',

    // ÊîØ‰ªòÊúçÂãô
    'api.adyen.com', 'api.braintreegateway.com', 'api.ecpay.com.tw',
    'api.stripe.com', 'api.paypal.com', 'checkout.paypal.com',

    // Á§æ‰∫§Âπ≥Âè∞ API
    'api.discord.com', 'api.twitch.tv', 'graph.instagram.com',
    'api.twitter.com', 'api.linkedin.com', 'api.reddit.com',

    // Âè∞ÁÅ£Êú¨Âú∞ÊúçÂãô
    'api.map.ecpay.com.tw', 'payment.ecpay.com.tw', 'kktix.com',
    'tixcraft.com', 'gov.tw', 'edu.tw', 'org.tw', 'com.tw', 'net.tw'
  ]),

  // ‚úÖ Á°¨ÁôΩÂêçÂñÆ - Ëê¨Áî®Â≠óÂÖÉÂåπÈÖç
  HARD_WHITELIST_WILDCARDS: createValidatedSet([
    // Âè∞ÁÅ£ÈäÄË°å
    'cathaybk.com.tw', 'ctbcbank.com', 'esunbank.com.tw', 'firstbank.com.tw',
    'fubon.com', 'megabank.com.tw', 'richart.tw', 'sinopac.com', 'taishinbank.com.tw',

    // ÊîøÂ∫úÁ∂≤Á´ô
    'gov.tw', 'org.tw', 'edu.tw',

    // Ê†∏ÂøÉÁ∂≤Ë∑ØÊúçÂãô
    'googleapis.com', 'gstatic.com', 'icloud.com', 'windowsupdate.com',
    'microsoft.com', 'apple.com', 'amazon.com',

    // ÂÖßÂÆπÂÇ≥ÈÅû
    'googlevideo.com', 'ytimg.com', 'youtube.com', 'youtu.be'
  ]),

  // üö´ ÈªëÂêçÂñÆ - Á≤æÁ¢∫ÂüüÂêçÂåπÈÖç (ÂøÖÂÆöÊîîÊà™)
  BLOCK_DOMAINS: createValidatedSet([
    // Google ËøΩËπ§ËàáÂª£Âëä
    'google-analytics.com', 'googletagmanager.com', 'googlesyndication.com',
    'googleadservices.com', 'doubleclick.net', 'adsense.com', 'admob.com',
    'googletagservices.com',

    // Facebook/Meta ËøΩËπ§
    'connect.facebook.net', 'business.facebook.com', 'analytics.facebook.com',
    'pixel.facebook.com',

    // Amazon ËøΩËπ§
    'amazon-adsystem.com', 'media-amazon.com', 'assoc-amazon.com',

    // Microsoft ËøΩËπ§
    'c.clarity.ms', 'bat.bing.com',

    // Adobe ÂàÜÊûê
    'omtrdc.net', 'demdex.net', 'omniture.com',

    // ‰∏ªË¶ÅÂàÜÊûêÂπ≥Âè∞
    'amplitude.com', 'mixpanel.com', 'segment.io', 'segment.com',
    'hotjar.com', 'fullstory.com', 'heap.io', 'posthog.com',

    // Âª£ÂëäÁ∂≤Ë∑Ø
    'adsrvr.org', 'criteo.com', 'criteo.net', 'outbrain.com',
    'taboola.com', 'mgid.com', 'revcontent.com', 'adsystem.com',

    // Ë°åÂãïÂàÜÊûê
    'appsflyer.com', 'adjust.com', 'branch.io', 'kochava.com',
    'flurry.com', 'localytics.com',

    // ‰∏≠ÂúãÊúçÂãô
    'umeng.com', 'umeng.cn', 'cnzz.com',

    // TikTok ÂàÜÊûê
    'analytics.tiktok.com', 'ads.tiktok.com', 'events.tiktok.com',

    // LinkedIn ÂàÜÊûê
    'ads.linkedin.com', 'analytics.linkedin.com', 'bizographics.com',

    // Twitter/X ÂàÜÊûê
    'analytics.twitter.com', 'ads-twitter.com',

    // ÂÖ∂‰ªñËøΩËπ§
    'scorecardresearch.com', 'quantserve.com', 'chartbeat.com',
    'newrelic.com', 'nr-data.net', 'bugsnag.com', 'sentry.io',
    'optimizely.com', 'vwo.com', 'kissmetrics.com'
  ]),

  // üö´ ÈªëÂêçÂñÆ - Ê≠£Ë¶èË°®ÈÅîÂºèÂåπÈÖç
  BLOCK_DOMAINS_REGEX: createValidatedRegexArray([
    '^ad[s]?\\d*\\.',
    '^track(ing)?\\.',
    '^metric[s]?\\.',
    '^telemetry\\.',
    '^analytics?\\.',
    '^stat[s]?\\.',
    '^log[s]?\\.',
    '^pixel\\.',
    '^beacon\\.',
    '^collect\\.'
  ]),

  // üö´ ÈóúÈçµËøΩËπ§ËÖ≥Êú¨ÂêçÁ®±
  TRACKING_SCRIPTS: createValidatedSet([
    'gtag.js', 'gtm.js', 'analytics.js', 'ga.js', 'adsbygoogle.js',
    'fbevents.js', 'fbq.js', 'pixel.js', 'connect.js',
    'amplitude.js', 'mixpanel.js', 'segment.js', 'heap.js',
    'hotjar.js', 'fullstory.js', 'clarity.js', 'posthog.js',
    'tracker.js', 'tracking.js', 'beacon.js', 'collect.js',
    'event.js', 'conversion.js', 'attribution.js'
  ]),

  // üö´ ÂèØÁñëË∑ØÂæëÈóúÈçµÂ≠ó
  SUSPICIOUS_PATHS: [
    '/collect', '/track', '/event', '/pixel', '/beacon',
    '/analytics', '/metrics', '/telemetry', '/log',
    '/impression', '/click', '/conversion', '/attribution'
  ]
};

// ================================================================================================
//                           üîç STEP 3: URL PARSING & VALIDATION
// ================================================================================================

function parseURL(urlString) {
  if (!urlString || typeof urlString !== 'string') {
    return null;
  }

  // Èï∑Â∫¶Ê™¢Êü•
  if (urlString.length > CONFIG.PERFORMANCE.MAX_URL_LENGTH) {
    console.warn(`[URLFilter] URL too long: ${urlString.length} chars`);
    return null;
  }

  try {
    // ÊñπÊ≥ï1: Ê®ôÊ∫ñ URL Ëß£Êûê
    const urlObj = new URL(urlString);
    return {
      hostname: urlObj.hostname.toLowerCase(),
      pathname: urlObj.pathname.toLowerCase(),
      isValid: true
    };
  } catch (error1) {
    try {
      // ÊñπÊ≥ï2: Ê≠£Ë¶èË°®ÈÅîÂºèËß£Êûê (fallback)
      const match = urlString.match(/^(?:https?:\/\/)?([^\/\?]+)(\/[^\?]*)?/);
      if (match && match[1]) {
        return {
          hostname: match[1].toLowerCase(),
          pathname: (match[2] || '/').toLowerCase(),
          isValid: true
        };
      }
    } catch (error2) {
      console.error('[URLFilter] URL parsing failed:', error2);
    }
    return null;
  }
}

// ================================================================================================
//                           üéØ STEP 4: MAIN FILTERING LOGIC
// ================================================================================================

class SimpleCache {
  constructor(maxSize = 1000) {
    this.cache = new Map();
    this.maxSize = maxSize;
  }

  get(key) {
    const value = this.cache.get(key);
    if (value !== undefined) {
      // ÁßªÂà∞ÊúÄÂæå (LRU)
      this.cache.delete(key);
      this.cache.set(key, value);
    }
    return value;
  }

  set(key, value) {
    // Ê∏ÖÁêÜËàäÈ†ÖÁõÆ
    if (this.cache.size >= this.maxSize && !this.cache.has(key)) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    this.cache.set(key, value);
  }

  clear() {
    this.cache.clear();
  }
}

class URLFilterEngine {
  constructor() {
    this.cache = new SimpleCache(CONFIG.PERFORMANCE.CACHE_SIZE);
    this.stats = {
      total: 0,
      blocked: 0,
      allowed: 0
    };

    if (CONFIG.PERFORMANCE.DEBUG_MODE) {
      console.log('[URLFilter] Engine initialized with configurations:', {
        redirectors: CONFIG.REDIRECTOR_HOSTS.size,
        hardWhitelistExact: CONFIG.HARD_WHITELIST_EXACT.size,
        hardWhitelistWildcards: CONFIG.HARD_WHITELIST_WILDCARDS.size,
        blockDomains: CONFIG.BLOCK_DOMAINS.size,
        blockRegexes: CONFIG.BLOCK_DOMAINS_REGEX.length
      });
    }
  }

  // üéØ ‰∏ªË¶ÅÈÅéÊøæÊñπÊ≥ï
  filter(urlString) {
    this.stats.total++;

    // Ê™¢Êü•Âø´Âèñ
    const cached = this.cache.get(urlString);
    if (cached !== undefined) {
      if (CONFIG.PERFORMANCE.DEBUG_MODE) {
        console.log(`[URLFilter] Cache hit: ${urlString} -> ${cached}`);
      }
      return cached;
    }

    // Ëß£Êûê URL
    const urlData = parseURL(urlString);
    if (!urlData || !urlData.isValid) {
      if (CONFIG.PERFORMANCE.DEBUG_MODE) {
        console.log(`[URLFilter] Invalid URL: ${urlString}`);
      }
      return this.makeDecision('ALLOW', urlString);
    }

    const { hostname, pathname } = urlData;

    try {
      // === Á¨¨‰∏ÄÁ¥öÔºöÂïüÁôºÂºèÁõ¥Ë∑≥ÂüüÂêçÊ™¢Êü• ===
      if (this.checkRedirectorHosts(hostname)) {
        return this.makeDecision('ALLOW', urlString, 'REDIRECTOR');
      }

      // === Á¨¨‰∫åÁ¥öÔºöÁ°¨ÁôΩÂêçÂñÆÊ™¢Êü• ===
      if (this.checkHardWhitelist(hostname)) {
        return this.makeDecision('ALLOW', urlString, 'HARD_WHITELIST');
      }

      // === Á¨¨‰∏âÁ¥öÔºöÈªëÂêçÂñÆÊ™¢Êü• ===
      if (this.checkBlockDomains(hostname)) {
        return this.makeDecision('REJECT', urlString, 'BLOCK_DOMAIN');
      }

      // === Á¨¨ÂõõÁ¥öÔºöÊ≠£Ë¶èË°®ÈÅîÂºèÈªëÂêçÂñÆÊ™¢Êü• ===
      if (this.checkBlockRegex(hostname)) {
        return this.makeDecision('REJECT', urlString, 'BLOCK_REGEX');
      }

      // === Á¨¨‰∫îÁ¥öÔºöËøΩËπ§Ë∑ØÂæëÊ™¢Êü• ===
      if (this.checkSuspiciousPaths(pathname)) {
        return this.makeDecision('REJECT', urlString, 'SUSPICIOUS_PATH');
      }

      // === Á¨¨ÂÖ≠Á¥öÔºöËøΩËπ§ËÖ≥Êú¨Ê™¢Êü• ===
      if (this.checkTrackingScripts(pathname)) {
        return this.makeDecision('REJECT', urlString, 'TRACKING_SCRIPT');
      }

      // === È†êË®≠ÔºöÂÖÅË®± ===
      return this.makeDecision('ALLOW', urlString, 'DEFAULT');

    } catch (error) {
      console.error('[URLFilter] Filter error:', error);
      return this.makeDecision('ALLOW', urlString, 'ERROR');
    }
  }

  // Ê™¢Êü•ÂïüÁôºÂºèÁõ¥Ë∑≥ÂüüÂêç
  checkRedirectorHosts(hostname) {
    return CONFIG.REDIRECTOR_HOSTS.has(hostname);
  }

  // Ê™¢Êü•Á°¨ÁôΩÂêçÂñÆ
  checkHardWhitelist(hostname) {
    // Á≤æÁ¢∫ÂåπÈÖç
    if (CONFIG.HARD_WHITELIST_EXACT.has(hostname)) {
      return true;
    }

    // Ëê¨Áî®Â≠óÂÖÉÂåπÈÖç
    for (const domain of CONFIG.HARD_WHITELIST_WILDCARDS) {
      if (hostname === domain || hostname.endsWith('.' + domain)) {
        return true;
      }
    }

    return false;
  }

  // Ê™¢Êü•ÈªëÂêçÂñÆÂüüÂêç
  checkBlockDomains(hostname) {
    return CONFIG.BLOCK_DOMAINS.has(hostname);
  }

  // Ê™¢Êü•Ê≠£Ë¶èË°®ÈÅîÂºèÈªëÂêçÂñÆ
  checkBlockRegex(hostname) {
    for (const regex of CONFIG.BLOCK_DOMAINS_REGEX) {
      try {
        if (regex.test(hostname)) {
          return true;
        }
      } catch (error) {
        console.error('[URLFilter] Regex test error:', error);
      }
    }
    return false;
  }

  // Ê™¢Êü•ÂèØÁñëË∑ØÂæë
  checkSuspiciousPaths(pathname) {
    for (const suspiciousPath of CONFIG.SUSPICIOUS_PATHS) {
      if (pathname.includes(suspiciousPath.toLowerCase())) {
        return true;
      }
    }
    return false;
  }

  // Ê™¢Êü•ËøΩËπ§ËÖ≥Êú¨
  checkTrackingScripts(pathname) {
    for (const script of CONFIG.TRACKING_SCRIPTS) {
      if (pathname.includes(script.toLowerCase())) {
        return true;
      }
    }
    return false;
  }

  // Ë£Ω‰ΩúÊ±∫Á≠ñ
  makeDecision(decision, urlString, reason = '') {
    // Êõ¥Êñ∞Áµ±Ë®à
    if (decision === 'REJECT') {
      this.stats.blocked++;
    } else {
      this.stats.allowed++;
    }

    // Âø´ÂèñÊ±∫Á≠ñ
    this.cache.set(urlString, decision);

    // Èô§ÈåØÊó•Ë™å
    if (CONFIG.PERFORMANCE.DEBUG_MODE) {
      console.log(`[URLFilter] ${decision} (${reason}): ${urlString}`);
    }

    return decision;
  }

  // ÂèñÂæóÁµ±Ë®à
  getStats() {
    return {
      version: '40.83',
      total: this.stats.total,
      blocked: this.stats.blocked,
      allowed: this.stats.allowed,
      blockRate: this.stats.total > 0 ? 
        ((this.stats.blocked / this.stats.total) * 100).toFixed(2) + '%' : '0%',
      cacheSize: this.cache.cache.size
    };
  }

  // Ê∏ÖÁêÜÂø´Âèñ
  clearCache() {
    this.cache.clear();
    console.log('[URLFilter] Cache cleared');
  }
}

// ================================================================================================
//                           üöÄ STEP 5: SURGE INTEGRATION
// ================================================================================================

// Âª∫Á´ãÂÖ®ÂüüÈÅéÊøæÂô®ÂØ¶‰æã
let filterEngine;

try {
  filterEngine = new URLFilterEngine();
  console.log('[URLFilter] Version 40.83 initialized successfully');
} catch (error) {
  console.error('[URLFilter] Initialization failed:', error);
  filterEngine = null;
}

// Surge ‰∏ªË¶ÅÂÖ•Âè£Èªû
async function main() {
  // Ê™¢Êü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑ request Áâ©‰ª∂
  if (typeof $request === 'undefined' || !$request || !$request.url) {
    console.error('[URLFilter] No valid request object found');
    $done({});
    return;
  }

  const url = $request.url;

  // Ê™¢Êü•ÈÅéÊøæÂô®ÊòØÂê¶ÂàùÂßãÂåñÊàêÂäü
  if (!filterEngine) {
    console.error('[URLFilter] Filter engine not initialized, allowing all requests');
    $done({});
    return;
  }

  try {
    // Âü∑Ë°åÈÅéÊøæ
    const decision = filterEngine.filter(url);

    if (decision === 'REJECT') {
      // ÊîîÊà™Ë´ãÊ±Ç - ËøîÂõûÁ©∫ÂõûÊáâ
      $done({
        response: {
          status: 204,
          headers: {
            'Content-Type': 'text/plain',
            'Content-Length': '0'
          },
          body: ''
        }
      });
    } else {
      // ÂÖÅË®±Ë´ãÊ±ÇÁπºÁ∫å
      $done({});
    }

  } catch (error) {
    console.error('[URLFilter] Main execution error:', error);
    // ÁôºÁîüÈåØË™§ÊôÇÈ†êË®≠ÂÖÅË®±
    $done({});
  }
}

// Ê™¢Êü•Âü∑Ë°åÁí∞Â¢É‰∏¶ÂïüÂãï
if (typeof $done === 'function') {
  // Surge Áí∞Â¢É
  main();
} else {
  // Ê∏¨Ë©¶Áí∞Â¢É
  console.log('[URLFilter] Running in test mode');

  // Ê∏¨Ë©¶ÁØÑ‰æã
  const testUrls = [
    'https://www.google.com',
    'https://google-analytics.com/collect',
    'https://chatgpt.com/api',
    'https://doubleclick.net/ads'
  ];

  if (filterEngine) {
    for (const testUrl of testUrls) {
      const result = filterEngine.filter(testUrl);
      console.log(`Test: ${testUrl} -> ${result}`);
    }
    console.log('Stats:', filterEngine.getStats());
  }
}
