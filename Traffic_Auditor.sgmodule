#!name=Traffic Auditor (Telemetry Hunter)
#!desc=[V1.0] é™æ¸¬çµäººï¼šè‡ªå‹•åµæ¸¬ä¸¦è­¦å ±ã€Œå¤§ä¸Šå‚³ã€å°ä¸‹è¼‰ã€çš„å¯ç–‘æµé‡ã€‚é©ç”¨æ–¼æ•æ‰éš±è”½çš„æ—¥èªŒä¸Šå‚³è¡Œç‚ºã€‚é è¨­é–¾å€¼ï¼šä¸Šå‚³ > 50KBã€‚
#!category=Diagnostics
#!system=ios

[Script]
# ç›£æ§ HTTP è«‹æ±‚ (éœ€é–‹å•Ÿ MITM æ‰èƒ½ç²¾ç¢ºè®€å– HTTPS Body å¤§å°)
# ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘åªé‡å° API é¡å‹çš„åŸŸåé€²è¡Œ Body æª¢æŸ¥ï¼Œæˆ–ä½¿ç”¨ Header åˆ¤æ–·
Traffic_Auditor=type=http-request,pattern=^https?://,script-path=https://raw.githubusercontent.com/fkhb90/Surge/main/TrafficAuditor/script.js,script-update-interval=0,debug=1,requires-body=true,timeout=5

[General]
# é€™è£¡ä½¿ç”¨ Inline Script ä»¥ç¢ºä¿æ‚¨æ–¹ä¾¿è¤‡è£½ä½¿ç”¨ï¼Œç„¡éœ€é¡å¤–è¨—ç®¡ JS æª”æ¡ˆ
# æ³¨æ„ï¼šåœ¨ Surge æ¨¡çµ„ä¸­ï¼ŒInline Script éœ€é€é argument å‚³éæˆ–å¯«åœ¨ Script å€æ®µ
# ç”±æ–¼ Surge Module æ ¼å¼é™åˆ¶ï¼Œä»¥ä¸‹ç‚ºå®Œæ•´çš„ Script é‚è¼¯å°è£

[Script]
Traffic_Auditor_Logic=type=http-request,pattern=^https?://,script-path=data:text/javascript;base64,==,requires-body=true

# Base64 è§£ç¢¼å¾Œçš„åŸå§‹ç¢¼é‚è¼¯ (ä¾›æ‚¨åƒè€ƒèˆ‡ä¿®æ”¹):
# const THRESHOLD = 50 * 1024; // 50KB
# const AUTO_REJECT = false;   // [è¨­å®š] true = è‡ªå‹•é˜»æ“‹; false = åƒ…é€šçŸ¥
# const url = $request.url;
# const method = $request.method;
#
# // æ’é™¤æ¸…å–® (ç™½åå–® - é¿å…èª¤æ®ºæ­£å¸¸ä¸Šå‚³)
# if (method !== "POST" || 
#     url.includes("icloud.com") || 
#     url.includes("dropbox") || 
#     url.includes("upload") || 
#     url.includes("googlevideo") ||
#     url.includes("netflix") ||
#     url.includes("httpbin.org")) { // æ¸¬è©¦ç”¨ç™½åå–®
#     $done({});
# } else {
#     let size = 0;
#     if ($request.body) {
#         size = $request.body.length;
#     } else {
#         // å˜—è©¦å¾ Header è®€å–
#         const len = $request.headers['Content-Length'] || $request.headers['content-length'];
#         if (len) size = parseInt(len);
#     }
#
#     if (size > THRESHOLD) {
#         const msg = `Size: ${(size/1024).toFixed(1)} KB | URL: ${url.substring(0, 50)}...`;
#         
#         if (AUTO_REJECT) {
#             $notification.post("ğŸ›¡ï¸ å·²è‡ªå‹•æ””æˆªå¤§æµé‡ä¸Šå‚³", msg, "Action: 403 Forbidden");
#             console.log(`[Traffic Auditor] REJECTED High Upload: ${size} bytes to ${url}`);
#             // ç›´æ¥å›å‚³ 403ï¼Œä¸­æ–·è«‹æ±‚
#             $done({
#                 response: {
#                     status: 403,
#                     body: "Blocked by Traffic Auditor: Upload size exceeded limit."
#                 }
#             });
#         } else {
#             $notification.post("ğŸš¨ ç™¼ç¾å¤§æµé‡ä¸Šå‚³", msg, "Action: Monitor Only");
#             console.log(`[Traffic Auditor] MONITOR High Upload: ${size} bytes to ${url}`);
#             $done({});
#         }
#     } else {
#         $done({});
#     }
# }
