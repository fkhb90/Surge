#!name=Traffic Auditor (Telemetry Hunter)
#!desc=[V2.0] é™æ¸¬çµäººï¼šè‡ªå‹•åµæ¸¬ä¸¦è­¦å ±ã€Œå¤§ä¸Šå‚³ã€å°ä¸‹è¼‰ã€çš„å¯ç–‘æµé‡ã€‚
#!category=Diagnostics
#!system=ios
#!arguments=mode: {type=select, title="é˜²ç¦¦æ¨¡å¼", description="é¸æ“‡åµæ¸¬åˆ°å¤§æµé‡æ™‚çš„å‹•ä½œ", items={monitor:"åƒ…ç›£æ§ (Monitor Only)", reject:"è‡ªå‹•æ””æˆª (Auto Reject)"}, default="monitor"}, threshold: {type=text, title="è§¸ç™¼é–¾å€¼ (KB)", description="ä¸Šå‚³å¤§æ–¼æ­¤æ•¸å€¼(KB)æ™‚è§¸ç™¼", default="50"}


[Script]
# ç›£æ§ HTTP è«‹æ±‚ (éœ€é–‹å•Ÿ MITM æ‰èƒ½ç²¾ç¢ºè®€å– HTTPS Body å¤§å°)
# ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘åªé‡å° API é¡å‹çš„åŸŸåé€²è¡Œ Body æª¢æŸ¥ï¼Œæˆ–ä½¿ç”¨ Header åˆ¤æ–·
Traffic_Auditor=type=http-request,pattern=^https?://,script-path=https://raw.githubusercontent.com/fkhb90/Surge/main/TrafficAuditor/script.js,script-update-interval=0,debug=1,requires-body=true,timeout=5,argument=mode={mode}&threshold={threshold}


[General]
# Inline Script Logic
# ç‚ºäº†é©é… argumentï¼Œæˆ‘å€‘éœ€è¦åœ¨è…³æœ¬ä¸­è§£æ $argument

[Script]
Traffic_Auditor_Logic=type=http-request,pattern=^https?://,script-path=data:text/javascript;base64,==,requires-body=true,argument=mode={mode}&threshold={threshold}


# ---------------------------------------------------
# JS åŸå§‹ç¢¼é‚è¼¯ (è«‹åƒè€ƒä¸‹æ–¹èªªæ˜ï¼Œæ­¤è™•ç‚º Base64 è§£ç¢¼å‰å…§å®¹)
# ---------------------------------------------------
#
# // è§£æåƒæ•¸
# let args = {};
# if (typeof $argument !== 'undefined') {
#     $argument.split('&').forEach(pair => {
#         let [key, value] = pair.split('=');
#         args[key] = value;
#     });
# }
#
# const MODE = args.mode || "monitor"; // 'monitor' or 'reject'
# const KB_LIMIT = parseInt(args.threshold || "50");
# const THRESHOLD = KB_LIMIT * 1024;
# const url = $request.url;
# const method = $request.method;
#
# // ç™½åå–®æª¢æŸ¥... (åŒå‰ç‰ˆ)
# if (method !== "POST" || url.includes("icloud.com") || url.includes("dropbox") || url.includes("upload") || url.includes("googlevideo") || url.includes("netflix")) {
#     $done({});
# } else {
#     let size = 0;
#     if ($request.body) {
#         size = $request.body.length;
#     } else {
#         const len = $request.headers['Content-Length'] || $request.headers['content-length'];
#         if (len) size = parseInt(len);
#     }
#
#     if (size > THRESHOLD) {
#         const msg = `Size: ${(size/1024).toFixed(1)} KB | URL: ${url.substring(0, 50)}...`;
#         
#         if (MODE === "reject") {
#             $notification.post("ğŸ›¡ï¸ å·²è‡ªå‹•æ””æˆª", msg, "Action: 403 Forbidden");
#             console.log(`[Traffic Auditor] REJECTED High Upload: ${size} bytes`);
#             $done({ response: { status: 403, body: "Blocked by Traffic Auditor" } });
#         } else {
#             $notification.post("ğŸš¨ ç™¼ç¾å¤§æµé‡ä¸Šå‚³", msg, "Action: Monitor Only");
#             console.log(`[Traffic Auditor] MONITOR High Upload: ${size} bytes`);
#             $done({});
#         }
#     } else {
#         $done({});
#     }
# }
